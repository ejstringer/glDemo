---
title: "dartR data structure and data input"
author: "Arthur Georges and Emily Stringer"
output:
  learnr::tutorial:
    progressive: false
    theme: "united"
    highlight: "tango"
    css: 
    - ./css/discovr_style_future2.css
    - ./css/custom_call.css
runtime: shiny_prerendered
description: "data in dartR"
---

<html lang="en">

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

#necessary to render tutorial correctly
library(learnr) 
library(htmltools)

library(dartR.data)
library(dartR.base)

library(glDemo)


```


```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy()
```


## Getting started

In this worked example, we will access the sample data files provided on the [**dartR web page**](http://dartr.biomatix.org/dartR)

-   **sample_data_2Row.csv**

-   **sample_data_silicodart.csv**

-   **sample_metadata.csv**



### Assign a working directory, download raw data

A first step is to assign a working directory

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}

:::

::: {.column width="80%"}

Create a project using the RStudio menu (File - New Project) and set the default directory for files using The RStudio menu (Session - Set Working Directory). Alternatively use [set.wd()]{style="color:#007bff;"}.

Also set the global verbosity level to 3 to provided detailed diagnostics, [gl.set.verbosity(3)]{style="color:#007bff;"}
:::

::::

:::



### Download raw data

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}

:::

::: {.column width="80%"}

Download the two datafiles using the links provided above and place them in the working directory. Open the file [sample_data_2Row.csv]{style="color:#007bff;"} in Excel. This is a set of SNP data for Emydura, a freshwater turtle, in 2-row format as would be supplied by Diversity Arrays Technology Pty Ltd.

:::

::::

:::

The contents and format of the csv file do not need to concern you. dartR handles all the complexities. If you do want to learn more, refer to the MetaDataDefinition file provided by Diversity Arrays Technology as part of their report. In this case, a definition file is provided as [sample_metadata.xlsx]{style="color:#cc9900; font-family: 'Courier New';"}. You can also go to the [Diversity Arrays Technology ([DArT]{style="color:#cc9900;"})](https://www.diversityarrays.com/) website.

### Download the individual metadata file

Recall that the individual metadata comprise attributes assigned to each individual.

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}

:::

::: {.column width="80%"}

<br> Download the individual metadata file datafile [sample_metadata.csv]{style="color:#007bff;"} using the link provided above and place it in the working directory.

Open the file in Excel and examine its contents.

:::

::::

:::


The individual metadata file [sample_metadata.csv]{style="color:#007bff; font-family: 'Courier New';"} has two compulsory fields **id** and **pop**, and some optional fields **lat**, **long**, **sex** and **maturity** associated with each individual. You can add whatever attributes you like to this metadata file.

### Read the data into dartR


Read the data from [sample_data_2Row.csv]{style="color:#007bff;"} into a dartR object and assign the individual metrics:

<small>Below are two tabs, the first is the code and the second is the output generated when running the code - loading in a dartR object. In the upper left hand corner of the code tab there is an icon to copy the code chunk (this applies for all code chunks in this tutorial).</small>

#### {.tabset}

##### code

```{r, eval = FALSE}
gl <- gl.read.dart(filename="./sample_data_2Row.csv",
                   ind.metafile="./samplemetadata1.csv")
```

##### output

```{r, echo = FALSE}
gl <- gl.read.dart(filename="./www/sample_data_2Row.csv",
                   ind.metafile="./www/samplemetadata1.csv")
```

## Interrogate

### Interrogate the dartR genlight object

Let's examine the contents of the dartR object.

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}

:::

::: {.column width="80%"}

Undertake some basic diagnostics using:

```{r eval = FALSE}

nInd(gl)
nLoc(gl)
nPop(gl) 

```

Maybe check the population and individual names:

```{r eval = FALSE}
popNames(gl)
indNames(gl)

```


<small>Try copying some of the code into the `R Code` box below, then press the *Run Code* button. To run new code simply press the *Start Over* to clear the console and output.</small>

:::

:::

:::

```{r data}
gl <- gl_sample 

```

```{r diag, exercise=TRUE, exercise.setup = "data"}

```

```{r diag-solution}
# try some of the functions listed above on the dartR object gl

# e.g.
nInd(gl)
```


```{r quiz1, echo = FALSE}


quiz(caption = "Quiz 1",
question_text(
  "What was the number of loci?",
  answer(250, message = "close, but that is the number of individuals not the number of loci"),
  answer(255, correct = TRUE),
  allow_retry = TRUE
),

question_text(
  "How many populations are there?",
  answer(30, correct = TRUE),
  allow_retry = TRUE
)

)

```


## Individual metrics

What do we have in the way of individual metrics?

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}
:::

::: {.column width="80%"}

dartR objects store individual metadat. Let's see what metadata is stored in our turtle data:

```{r eval = FALSE}
names(gl@other$ind.metrics)
```


:::

:::

:::

```{r met_datan, exercise=TRUE, exercise.setup = "data"}

```

```{r met_datan-solution}
names(gl@other$ind.metrics)
```


```{r rank, echo=FALSE}
rank_ex <- sortable::question_rank(
  "Sort ind.metric column names",
  learnr::answer(names(gl_sample@other$ind.metrics), correct = TRUE),
  learnr::answer(sort(names(gl_sample@other$ind.metrics)), correct = FALSE, "Not alphabetically! How they appear in the data"),
   allow_retry = TRUE
  
)

rank_ex
```

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}
:::

::: {.column width="80%"}


Next undertake some basic diagnostics: Examine the contents of the individual metrics, in this case the first 10 values of the attribute "sex":

```{r eval = FALSE}
## Only first 10 entries shown
gl@other$ind.metrics$sex[1:10]

```


:::

:::

:::

```{r met_data, exercise=TRUE, exercise.setup = "data"}

```

```{r met_data-solution}
# example
gl@other$ind.metrics$sex[1:10]
```


<small>Try it also with some other metrics.</small>

## Locus metrics 

What do we have in the way of locus metrics?

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}
:::

::: {.column width="80%"}

dartR objects also store locus metadat. Let's see what metadata is stored in our turtle data:


```{r eval = FALSE}
## List the names of metrics
names(gl@other$loc.metrics)
## Only entries for the first 10 individuals are shown
gl@other$loc.metrics$RepAvg[1:10]

```


:::

:::

:::

```{r met_datal, exercise=TRUE, exercise.setup = "data"}

```

```{r met_datal-solution}
names(gl@other$loc.metrics)
```

Try it also with some other metrics.

## Save and tidy

### Save the dartR genlight object in compact form

Raw data files can be very large and take time to read into dartR. It is something you only want to do once. You can save your dartR genlight object in compact binary form. This will take only seconds to load into RStudio, not minutes.


::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="20%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}
:::

::: {.column width="80%"}

Try saving [gl]{style="color:blue;"} or your own genlight object to your workspace, and verify that it has been saved to the appropriate directory. Then restore it to a new genlight object.


```{r eval = FALSE}
gl.save(gl,"turtle.Rdata")
gl.new <- gl.load("turtle.Rdata")
```


:::

:::

:::





### Tidy up the Workspace

We have created files that we will not use again, so they should be removed from the workspace.

::: {.my-solution icon="false"}

:::: {style="display: flex;"}

::: {.column width="17%"}

<br> ![](./images/task.png){#id .class width="100" height="100"}
:::

::: {.column width="83%"}

Tidy up your workspace by removing the genlight objects gl and gl.new, assuming you do not want to access them again in raw form.


```{r eval = FALSE}
rm(gl, gl.new)
```


:::

:::

:::

### You are now a pro!

## Exercises

### Exercise 1: 1-Row Format

-   Open the file sample_data_1Row.csv in Excel. This is a set of SNP data for Emydura, a freshwater turtle, in 1-row format as would be supplied by Diversity Arrays Technology Pty Ltd.

-   Refer to the documentation on the Diversity Arrays Technology web page to understand the scoring of SNPs in the 1-row format.

-   Also refer to the MetaDataDefinition file provided by Diversity Arrays Technology as part of their report. In this case, a definition file is provided as sample_metadata.xlsx.

-   Now examine the individual metadata in the file sample_data_1Row.csv. Note the two mandatory columns id and pop.

-   Create a new script in the RStudio Editor Window and add the lines

```{r}
# EXERCISE 1: 1-Row Format
# Input data from sample_data_1Row.csv, 
#   associate with sample_data_1Row.csv

```

-   Add a statement to read the SNP data in to dartR as a genlight object called gl.1row

-   Add a statement to examine a summary of the contents of gl.1row

-   Use the as.matrix() function to display the genotypes for the first 5 individuals and the first 10 loci.

### Exercise 2: SilicoDArT

-   Open the file sample_data_silicodart.csv in Excel. This is a set of marker presence/absence data for Cherax destructor provided in SilicoDArT format by Diversity Arrays Technology Pty Ltd.

-   Refer to the documentation on the Diversity Arrays Technology web page to understand the scoring of the data in the SilicoDArT format.

-   Also refer to the MetaDataDefinition file provided by Diversity Arrays Technology as part of their report. In this case, a definition file is provided as sample_metadata.xlsx.

-   Now examine the individual metadata in the file sample_data_1Row.csv. Note the two mandatory columns id and pop.

-   Create a new script in the RStudio Editor Window and add the lines

```{r}
# EXERCISE 2: SilicoDArT data
# Input data from sample_data_SilicoDArT.csv, 
#  associate with sample_data_SilicoDArT.csv
```

-   Add a statement to read the SNP data in to dartR as a genlight object called gs.

-   Add a statement to examine a summary of the contents of gs.

-   Use the `as.matrix()` function to display the genotypes for the first 5 individuals and the first 10 loci.

